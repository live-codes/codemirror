import{Prec as O,StateEffect as P,StateField as A,MapMode as B,EditorSelection as d}from"@codemirror/state";import*as b from"@codemirror/view";import{EditorView as $,Direction as T,ViewPlugin as F,showPanel as N}from"@codemirror/view";import*as r from"@codemirror/commands";import{completionStatus as K,startCompletion as U}from"@codemirror/autocomplete";import{openSearchPanel as R}from"@codemirror/search";var w=b.getDrawSelectionConfig||function(){let a={cursorBlinkRate:1200};return function(){return a}}(),S=class{constructor(e,t,s,o,n,i,c,l,m,u){this.left=e,this.top=t,this.height=s,this.fontFamily=o,this.fontSize=n,this.fontWeight=i,this.color=c,this.className=l,this.letter=m,this.partial=u}draw(){let e=document.createElement("div");return e.className=this.className,this.adjust(e),e}adjust(e){e.style.left=this.left+"px",e.style.top=this.top+"px",e.style.height=this.height+"px",e.style.lineHeight=this.height+"px",e.style.fontFamily=this.fontFamily,e.style.fontSize=this.fontSize,e.style.fontWeight=this.fontWeight,e.style.color=this.partial?"transparent":this.color,e.className=this.className,e.textContent=this.letter}eq(e){return this.left==e.left&&this.top==e.top&&this.height==e.height&&this.fontFamily==e.fontFamily&&this.fontSize==e.fontSize&&this.fontWeight==e.fontWeight&&this.color==e.color&&this.className==e.className&&this.letter==e.letter}},y=class{constructor(e,t){this.view=e,this.rangePieces=[],this.cursors=[],this.em=t,this.measureReq={read:this.readPos.bind(this),write:this.drawSel.bind(this)},this.cursorLayer=e.scrollDOM.appendChild(document.createElement("div")),this.cursorLayer.className="cm-cursorLayer cm-vimCursorLayer",this.cursorLayer.setAttribute("aria-hidden","true"),e.requestMeasure(this.measureReq),this.setBlinkRate()}setBlinkRate(){let t=w(this.view.state).cursorBlinkRate;this.cursorLayer.style.animationDuration=t+"ms"}update(e){(e.selectionSet||e.geometryChanged||e.viewportChanged)&&(this.view.requestMeasure(this.measureReq),this.cursorLayer.style.animationName=this.cursorLayer.style.animationName=="cm-blink"?"cm-blink2":"cm-blink"),I(e)&&this.setBlinkRate()}scheduleRedraw(){this.view.requestMeasure(this.measureReq)}readPos(){let{state:e}=this.view,t=[];for(let s of e.selection.ranges){let o=s==e.selection.main,n=z(this.em,this.view,s,o);n&&t.push(n)}return{cursors:t}}drawSel({cursors:e}){if(e.length!=this.cursors.length||e.some((t,s)=>!t.eq(this.cursors[s]))){let t=this.cursorLayer.children;if(t.length!==e.length){this.cursorLayer.textContent="";for(let s of e)this.cursorLayer.appendChild(s.draw())}else e.forEach((s,o)=>s.adjust(t[o]));this.cursors=e}}destroy(){this.cursorLayer.remove()}};function I(a){return w(a.startState)!=w(a.state)}var j={".cm-line":{"& ::selection":{backgroundColor:"transparent !important"},"&::selection":{backgroundColor:"transparent !important"},caretColor:"transparent !important"},".cm-fat-cursor":{position:"absolute",background:"#ff9696",border:"none",whiteSpace:"pre"},"&:not(.cm-focused) .cm-fat-cursor":{background:"none",outline:"solid 1px #ff9696",color:"transparent !important"}},W=O.highest($.theme(j));function q(a){let e=a.scrollDOM.getBoundingClientRect();return{left:(a.textDirection==T.LTR?e.left:e.right-a.scrollDOM.clientWidth)-a.scrollDOM.scrollLeft,top:e.top-a.scrollDOM.scrollTop}}function z(a,e,t,s){var o,n;let i=t.head,c=1;(a.$data.count||a.$data.keyChain)&&(c=.5);{let m=i<e.state.doc.length&&e.state.sliceDoc(i,i+1);m&&/[\uDC00-\uDFFF]/.test(m)&&i>1&&(i--,m=e.state.sliceDoc(i,i+1));let u=e.coordsAtPos(i,1);if(!u)return null;let v=q(e),f=e.domAtPos(i),g=f?f.node:e.contentDOM;for(;f&&f.node instanceof HTMLElement;)g=f.node,f={node:f.node.childNodes[f.offset],offset:0};if(!(g instanceof HTMLElement)){if(!g.parentNode)return null;g=g.parentNode}let C=getComputedStyle(g),k=u.left,L=(n=(o=e).coordsForChar)===null||n===void 0?void 0:n.call(o,i);if(L&&(k=L.left),!m||m==`
`||m=="\r")m="\xA0";else if(m=="	"){m="\xA0";var l=e.coordsAtPos(i+1,-1);l&&(k=l.left-(l.left-u.left)/parseInt(C.tabSize))}else/[\uD800-\uDBFF]/.test(m)&&i<e.state.doc.length-1&&(m+=e.state.sliceDoc(i+1,i+2));let D=u.bottom-u.top;return new S(k-v.left,u.top-v.top+D*(1-c),D*c,C.fontFamily,C.fontSize,C.fontWeight,C.color,s?"cm-fat-cursor cm-cursor-primary":"cm-fat-cursor cm-cursor-secondary",m,c!=1)}}var G=$.theme({".cm-emacsMode .cm-cursorLayer:not(.cm-vimCursorLayer)":{display:"none"},".cm-vim-panel":{padding:"5px 10px",backgroundColor:"#fffa8f",fontFamily:"monospace"},".cm-vim-panel input":{border:"none",outline:"none",backgroundColor:"#fffa8f"}}),H=F.fromClass(class{constructor(a){this.status="",this.view=a,this.em=new p(a),this.blockCursor=new y(a,this.em),this.view.scrollDOM.classList.add("cm-emacsMode")}update(a){a.docChanged&&(this.em.$emacsMark=null,this.em.updateMarksOnChange(a.changes)),this.blockCursor.update(a)}destroy(){this.view.scrollDOM.classList.remove("cm-emacsMode"),this.blockCursor.destroy()}},{eventHandlers:{keydown:function(a,e){var t=this.em.handleKeyboard(a);return t&&this.blockCursor.scheduleRedraw(),!!t},mousedown:function(){this.em.$emacsMark=null}}}),V=P.define(),Q=A.define({create:()=>!1,update(a,e){for(let t of e.effects)t.is(V)&&(a=t.value);return a},provide:a=>N.from(a,e=>e?J:null)});function J(a){let e=document.createElement("div");return e.className="cm-vim-panel",{top:!1,dom:e}}function X(a={}){return[G,H,W,Q]}var Y={Return:"Return",Escape:"Esc",Insert:"Ins",ArrowLeft:"Left",ArrowRight:"Right",ArrowUp:"Up",ArrowDown:"Down",Enter:"Return",Divide:"/",Slash:"/",Multiply:"*",Subtract:"-",Minus:"-",Equal:"="},Z={Shift:1,Alt:1,Command:1,Control:1,CapsLock:1},M={},p=class a{constructor(e){this.view=e,this.$data={count:0,keyChain:"",lastCommand:""},this.$emacsMarkRing=[],this.$emacsMark=null}static bindKey(e,t){e.split("|").forEach(function(s){let o="",n=s.split(/\s+/);n.forEach(function(i,c){let l=i.split(/-(?=.)/),m=l.pop();l.length&&(o+=l.sort().join("-")+"-"),o+=m,c===n.length-1?M[o]=t:(M[o]="null",o+=" ")})})}static getKey(e){var t=e.code,s=e.key;if(Z[s])return["","",""];t.length>1&&(t[0]=="N"&&(t=t.replace(/^Numpad/,"")),t[0]=="K"&&(t=t.replace(/^Key/,""))),t=Y[t]||t,t.length==1&&(t=t.toLowerCase());var o="";return e.ctrlKey&&(o+="C-"),e.metaKey&&(o+="CMD-"),e.altKey&&(o+="M-"),e.shiftKey&&(o+="S-"),[t,o,s]}static addCommands(e){Object.keys(e).forEach(function(t){var s=e[t];typeof s=="function"&&(s={exec:s}),a.commands[t]=s})}static execCommand(e,t,s,o=1){var n=void 0;if(o<0&&(o=-o),typeof e=="function")for(var i=0;i<o;i++)e(t.view);else if(e!=="null")if(e.exec){o>1&&e.handlesCount&&(s||(s={}),typeof s=="object"&&(s.count=o),o=1);for(var i=0;i<o;i++)n=e.exec(t,s||{})}else throw new Error("missformed command");return n}handleKeyboard(e){var t=a.getKey(e),s=this.findCommand(t);if(!(/Up|Down/.test(t?.[0])&&K(this.view.state))){if(s&&s.command){var o=a.execCommand(s.command,this,s.args,s.count);if(o===!1)return}return s}}findCommand([e,t,s]){if(e){var o=this,n=this.$data;if(!t&&e.length==1&&(o.pushEmacsMark(),n.count)){var i=new Array(n.count+1).join(s);return n.count=null,{command:"insertstring",args:i}}if(t=="C-"||n.count){var m=parseInt(e[e.length-1]);if(typeof m=="number"&&!isNaN(m))return n.count=Math.max(n.count||0,0),n.count=10*n.count+m,{command:"null"}}t&&(e=t+e),n.keyChain&&(e=n.keyChain+=" "+e);var c=M[e];if(n.keyChain=c=="null"?e:"",!!c){if(c==="null")return{command:"null"};if(c==="universalArgument")return n.count=-4,{command:"null"};var l;if(typeof c!="string"&&(l=c.args,c.command&&(c=c.command)),(c==="insertstring"||c===r.splitLine||c===r.toggleComment)&&o.pushEmacsMark(),!(typeof c=="string"&&(c=a.commands[c],!c))){!c.readOnly&&!c.keepLastCommand&&(n.lastCommand=null);var m=n.count||1;return n.count&&(n.count=0),{command:c,args:l,count:m}}}}}showCommandLine(e){console.error("TODO")}updateMarksOnChange(e){this.$emacsMark&&(this.$emacsMark=this.updateMark(this.$emacsMark,e)),this.$emacsMarkRing=this.$emacsMarkRing.map(t=>this.updateMark(t,e)).filter(Boolean)}updateMark(e,t){if(e){var s=e.map(function(o){return t.mapPos(o,1,B.TrackDel)}).filter(o=>o!=null);return s.length==0?null:s}}emacsMark(){return this.$emacsMark}setEmacsMark(e){this.$emacsMark=e}pushEmacsMark(e,t){var s=this.$emacsMark;s&&x(this.$emacsMarkRing,s),!e||t?this.setEmacsMark(e):x(this.$emacsMarkRing,e)}popEmacsMark(){var e=this.emacsMark();return e?(this.setEmacsMark(null),e):this.$emacsMarkRing.pop()}getLastEmacsMark(){return this.$emacsMark||this.$emacsMarkRing.slice(-1)[0]}getCopyText(){var e=this.view.state;return e.selection.ranges.map(t=>e.sliceDoc(t.from,t.to)).join(`
`)}clearSelection(){var e=this.view,t=e.state.selection,s=!t.ranges.some(n=>n.from!=n.to);if(s)return!1;var o=t.ranges.map(n=>d.range(n.head,n.head));return e.dispatch({selection:d.create(o,t.mainIndex)}),!0}onPaste(e){var t=this.view,s=t.state.selection,o;if(s.ranges.length>1){var n=e.split(`
`);n.length==s.ranges.length&&(o=n)}var i=0,c=t.state.changeByRange(l=>{var m=o?o[i]:e;return i++,{changes:{from:l.from,to:l.to,insert:m},range:d.cursor(l.from+m.length)}});t.dispatch(c)}selectionToEmacsMark(){var e=this.view.state.selection;return e.ranges.map(t=>t.head)}};p.commands={};function x(a,e){a.length&&a[a.length-1]+""==e+""||a.push(e)}var E={"Up|C-p":{command:"goOrSelect",args:[r.cursorLineUp,r.selectLineUp]},"Down|C-n":{command:"goOrSelect",args:[r.cursorLineDown,r.selectLineDown]},"Left|C-b":{command:"goOrSelect",args:[r.cursorCharBackward,r.selectCharBackward]},"Right|C-f":{command:"goOrSelect",args:[r.cursorCharForward,r.selectCharForward]},"C-Left|M-b":{command:"goOrSelect",args:[r.cursorGroupLeft,r.selectGroupLeft]},"C-Right|M-f":{command:"goOrSelect",args:[r.cursorGroupRight,r.selectGroupRight]},"Home|C-a":{command:"goOrSelect",args:[r.cursorLineStart,r.selectLineStart]},"End|C-e":{command:"goOrSelect",args:[r.cursorLineEnd,r.selectLineEnd]},"C-Home|S-M-,":{command:"goOrSelect",args:[r.cursorDocStart,r.selectDocStart]},"C-End|S-M-.":{command:"goOrSelect",args:[r.cursorDocEnd,r.selectDocEnd]},"S-Up|S-C-p":r.selectLineUp,"S-Down|S-C-n":r.selectLineDown,"S-Left|S-C-b":r.selectCharBackward,"S-Right|S-C-f":r.selectCharForward,"S-C-Left|S-M-b":r.selectGroupBackward,"S-C-Right|S-M-f":r.selectGroupForward,"S-Home|S-C-a":r.selectLineStart,"S-End|S-C-e":r.selectLineEnd,"S-C-Home":r.selectDocStart,"S-C-End":r.selectDocEnd,"C-l":"recenterTopBottom","M-s":"centerSelection","M-g":"gotoline","C-x C-p|C-x h":r.selectAll,"PageDown|C-v|C-Down":{command:"goOrSelect",args:[r.cursorPageDown,r.selectPageDown]},"PageUp|M-v|C-Up":{command:"goOrSelect",args:[r.cursorPageUp,r.selectPageDown]},"S-C-Down":r.selectPageDown,"S-C-Up":r.selectPageUp,"C-s":R,"C-r":R,"M-C-s":"findnext","M-C-r":"findprevious","S-M-5":"replace",Backspace:r.deleteCharBackward,"Delete|C-d":r.deleteCharForward,"Return|C-m":{command:"insertstring",args:`
`},"C-o":r.splitLine,"M-d|C-Delete":{command:"killWord",args:"right"},"C-Backspace|M-Backspace|M-Delete":{command:"killWord",args:"left"},"C-k":"killLine","M-h":"selectParagraph","M-@|M-S-2":"markWord","C-y|S-Delete":"yank","M-y":"yankRotate","C-g":"keyboardQuit","C-w|C-S-w":"killRegion","M-w":"killRingSave","C-Space":"setMark","C-x C-x":"exchangePointAndMark","C-t":r.transposeChars,"M-u":{command:"changeCase",args:{dir:1}},"M-l":{command:"changeCase",args:{dir:-1}},"C-x C-u":{command:"changeCase",args:{dir:1,region:!0}},"C-x C-l":{command:"changeCase",args:{dir:1,region:!0}},"M-/":U,"C-u":"universalArgument","M-;":r.toggleComment,"C-/|C-x u|S-C--|C-z":r.undo,"S-C-/|S-C-x u|C--|S-C-z":r.redo,"C-x r":"selectRectangularRegion","M-x":{command:"focusCommandLine",args:"M-x "},Esc:"unsetTransientMark"};for(let a in E)p.bindKey(a,E[a]);p.addCommands({unsetTransientMark:function(a){return a.setEmacsMark(null),!1},markWord:function(a,e){},selectParagraph:function(a,e){for(var t=a.view,s=t.state.selection.ranges[0].head,o=t.state.doc,n=o.lineAt(s),i=-1,c=-1,l=n;/\S/.test(l.text)&&l.from>0;)i=l.from,l=t.state.doc.lineAt(l.from-1);if(i==-1)for(;!/\S/.test(l.text)&&l.to<o.length;)i=l.from,l=t.state.doc.lineAt(l.to+1);else l=n;for(;/\S/.test(l.text)&&l.to<o.length;)c=l.to,l=t.state.doc.lineAt(l.to+1);c==-1&&(c=n.to);var m=[d.range(i,c)];t.dispatch({selection:d.create(m)})},goOrSelect:{exec:function(a,e){var t=a.emacsMark()?e[1]:e[0];t(a.view)}},changeCase:function(a,e){var t=a.view;e.region||(a.clearSelection(),r.selectGroupForward(t));var s=t.state.changeByRange(o=>{var n=t.state.sliceDoc(o.from,o.to);return n=e.dir==1?n.toUpperCase():n.toLowerCase(),{changes:{from:o.from,to:o.to,insert:n},range:d.cursor(o.from+n.length)}});t.dispatch(s)},centerSelection:function(a){a.view.dispatch({scrollIntoView:!0})},recenterTopBottom:function(a){var e=a.view,t=e.scrollDOM.scrollTop;e.dispatch({scrollIntoView:!0});try{e.measure(!0)}catch{}if(t==e.scrollDOM.scrollTop){var s=e.scrollDOM.getBoundingClientRect(),o=e.coordsAtPos(e.state.selection.main.head);if(o){var n=o.bottom-o.top,i=s.height,c=o.top-s.top;Math.abs(c)<n/4?t+=c+n-i+2:Math.abs(c-i*.5)<n/4?t+=c-2:t+=c-i*.5,e.scrollDOM.scrollTop=t}}},selectRectangularRegion:function(a){var e=a.view,t=e.state.selection.ranges,s=[];if(t.length>1)s.push(d.range(t[0].from,t[t.length-1].to));else{let o=e.state.doc,n=o.lineAt(t[0].from),i=o.lineAt(t[0].to),c=t[0].from-n.from,l=t[0].to-i.from;for(;n.from<i.to&&(s.push(d.range(n.from+c,n.from+l)),!(n.to+1>=o.length));)n=o.lineAt(n.to+1)}e.dispatch({selection:d.create(s)})},setMark:{exec:function(a,e){var t=a.view,s=t.state.selection.ranges;if(e&&e.count){var o=a.selectionToEmacsMark(),i=a.popEmacsMark();if(i){var n=i.map(u=>d.cursor(u,u));t.dispatch({selection:d.create(n)}),a.$emacsMarkRing.unshift(o)}return}var i=a.emacsMark(),c=s.map(function(m){return m.head}),l=s.every(function(m){return m.from==m.to});if(i||!l){a.clearSelection(),i&&a.pushEmacsMark(null);return}if(!i){a.pushEmacsMark(c),a.setEmacsMark(c);return}},readOnly:!0,handlesCount:!0},exchangePointAndMark:{exec:function(a,e){var t=a.view,s=t.state.selection,o=!s.ranges.some(u=>u.from!=u.to);if(!e.count&&!o){var n=s.ranges.map(u=>d.range(u.head,u.anchor));t.dispatch({selection:d.create(n,s.mainIndex)});return}var i=a.$emacsMarkRing,c=i[i.length-1];if(c)if(e.count){i[i.length-1]=a.selectionToEmacsMark(),a.clearSelection();var n=c.map(v=>d.range(v,v));t.dispatch({selection:d.create(n,s.mainIndex)})}else{var l=Math.min(c.length,s.ranges.length);n=[];for(var m=0;m<l;m++)n.push(d.range(s.ranges[m].head,c[m]))}},readOnly:!0,handlesCount:!0},killWord:{exec:function(a,e){var t=a.view,s=t.state.selection,o=s.ranges.map(n=>d.range(n.head,n.head));t.dispatch({selection:d.create(o,s.mainIndex)}),e=="left"?r.selectGroupBackward(t):r.selectGroupForward(t),s=t.state.selection,s.ranges.forEach(n=>{var i=t.state.sliceDoc(n.from,n.to);h.add(i)}),t.dispatch(t.state.replaceSelection(""))}},killLine:{exec:function(a){a.pushEmacsMark(null),a.clearSelection();var e=a.view,t=e.state,s=[],o=t.selection.ranges.map(function(n){var i=n.head,c=t.doc.lineAt(i),l=c.to,m=t.sliceDoc(i,l);return/^\s*$/.test(m)&&l<t.doc.length-1?(l+=1,s.push(m+`
`)):s.push(m),{from:i,to:l,insert:""}});a.$data.lastCommand=="killLine"?h.append(s.join(`
`)):h.add(s.join(`
`)),a.$data.lastCommand="killLine",e.dispatch({changes:o})},keepLastCommand:!0},yank:{exec:function(a){a.onPaste(h.get()),a.$data.lastCommand="yank"},keepLastCommand:!0},yankRotate:{exec:function(a){a.$data.lastCommand=="yank"&&(r.undo(a.view),a.$emacsMarkRing.pop(),a.onPaste(h.rotate()),a.$data.lastCommand="yank")},keepLastCommand:!0},killRegion:{exec:function(a){h.add(a.getCopyText());var e=a.view;e.dispatch(e.state.replaceSelection("")),a.setEmacsMark(null)}},killRingSave:{exec:function(a){var e=a.getCopyText();h.add(e),a.clearSelection(),navigator.clipboard.writeText(e)},readOnly:!0},keyboardQuit:function(a){var e=a.view,t=e.state.selection,s=!t.ranges.some(n=>n.from!=n.to);if(t.ranges.length>1&&!s){var o=t.ranges.map(n=>d.range(n.head,n.head));e.dispatch({selection:d.create(o,t.mainIndex)})}else r.simplifySelection(a.view);a.setEmacsMark(null),a.$data.count=null},focusCommandLine:function(a,e){a.showCommandLine(e)}});var h={$data:[],add:function(a){a&&this.$data.push(a),this.$data.length>30&&this.$data.shift()},append:function(a){var e=this.$data.length-1,t=this.$data[e]||"";a&&(t+=a),t&&(this.$data[e]=t)},get:function(a){return a=a||1,this.$data.slice(this.$data.length-a,this.$data.length).reverse().join(`
`)},pop:function(){return this.$data.length>1&&this.$data.pop(),this.get()},rotate:function(){let a=this.$data.pop();return a&&this.$data.unshift(a),this.get()}};export{X as emacs};
